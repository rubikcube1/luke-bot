<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Luke-Bot</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.58.1/build/stlite.css" />
    <style>
      body { margin: 0; background-color: #0e1117; }
    </style>
  </head>
  <body>
    <div id="stlite"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.58.1/build/stlite.js"></script>
    <script>
      stlite.mount({
        requirements: ["requests", "pandas"],
        entrypoint: "app.py",
        files: {
          "app.py": `
import streamlit as st
import requests
import json
import time
import xml.etree.ElementTree as ET
import pandas as pd

GROQ_API_KEY = "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"
GEMINI_API_KEY = "AIzaSyAzLMt-JM1smoMD7kA1CC4GO3-rPCgHb8s"
WOLFRAM_APPID = "LVT9LY-LYTPPU"
NCBI_API_KEY = "6b3d9fed81852b6da5596971edcecddd4909"

APP_NAME = "Luke-Bot"

st.set_page_config(page_title=APP_NAME, layout="wide")

st.markdown("""
<style>
    .stProgress > div > div > div > div {
        background-color: #3b82f6;
    }
    .main {
        background-color: #0e1117;
    }
</style>
""", unsafe_allow_html=True)

if "messages" not in st.session_state:
    st.session_state.messages = []
if "token_usage" not in st.session_state:
    st.session_state.token_usage = 100 

st.sidebar.title(APP_NAME)

category_main = st.sidebar.selectbox("大カテゴリー", [
    "理学 (Science)",
    "工学・技術 (Engineering & Tech)",
    "数学・統計学 (Mathematics)",
    "人文・社会科学 (Liberal Arts)",
    "クリエイティブ & 実用"
])

if category_main == "理学 (Science)":
    category_mid = st.sidebar.selectbox("中カテゴリー", ["物理学", "宇宙・天文学", "生命科学", "化学", "地球科学"])
    if category_mid == "物理学":
        detail_item = st.sidebar.selectbox("詳細項目", ["量子力学", "相対性理論", "素粒子物理学", "物性物理"])
    elif category_mid == "宇宙・天文学":
        detail_item = st.sidebar.selectbox("詳細項目", ["恒星物理", "宇宙論 (ArXiv)", "惑星科学"])
    elif category_mid == "生命科学":
        detail_item = st.sidebar.selectbox("詳細項目", ["分子生物学 (NCBI)", "遺伝工学", "神経科学"])
    else:
        detail_item = st.sidebar.selectbox("詳細項目", ["有機化学", "無機化学", "気象学"])

elif category_main == "工学・技術 (Engineering & Tech)":
    category_mid = st.sidebar.selectbox("中カテゴリー", ["コンピュータ工学", "ロボティクス", "材料工学", "エネルギー工学"])
    if category_mid == "コンピュータ工学":
        detail_item = st.sidebar.selectbox("詳細項目", ["OS・カーネル", "分散システム", "ハードウェア設計"])
    elif category_mid == "ロボティクス":
        detail_item = st.sidebar.selectbox("詳細項目", ["制御理論", "自律走行", "センサー工学"])
    else:
        detail_item = st.sidebar.selectbox("詳細項目", ["ナノマテリアル", "半導体技術", "再生可能エネルギー"])

elif category_main == "数学・統計学 (Mathematics)":
    category_mid = st.sidebar.selectbox("中カテゴリー", ["純粋数学", "応用数学", "統計・データサイエンス", "数学上の未解決問題"])
    if category_mid == "純粋数学":
        detail_item = st.sidebar.selectbox("詳細項目", ["数論 (Wolfram)", "代数幾何", "位相幾何学"])
    elif category_mid == "応用数学":
        detail_item = st.sidebar.selectbox("詳細項目", ["微分方程式", "数値解析", "離散数学"])
    elif category_mid == "数学上の未解決問題":
        detail_item = st.sidebar.selectbox("詳細項目", ["素数の分布", "双子素数の予想", "リーマン予想", "P対NP問題", "ナビエ-ストークス方程式"])
    else:
        detail_item = st.sidebar.selectbox("詳細項目", ["確率論", "多変量解析", "ベイズ統計"])

elif category_main == "人文・社会科学 (Liberal Arts)":
    category_mid = st.sidebar.selectbox("中カテゴリー", ["歴史学", "哲学・倫理学", "心理学", "法学・政治学", "経済学"])
    if category_mid == "歴史学":
        detail_item = st.sidebar.selectbox("詳細項目", ["日本古代史", "西洋近代史", "東洋思想史"])
    elif category_mid == "哲学・倫理学":
        detail_item = st.sidebar.selectbox("詳細項目", ["認識論", "形而上学", "応用倫理学"])
    else:
        detail_item = st.sidebar.selectbox("詳細項目", ["臨床心理学", "国際関係論", "行動経済学"])

else:
    category_mid = st.sidebar.selectbox("中カテゴリー", ["プログラミング・Web", "教育・学習", "キャリア・生活"])
    if category_mid == "プログラミング・Web":
        detail_item = st.sidebar.selectbox("詳細項目", ["Python", "Rust / C++", "Frontend (React)", "SQL"])
    elif category_mid == "教育・学習":
        detail_item = st.sidebar.selectbox("詳細項目", ["小学生向け勉強", "中学生向け勉強", "高校生向け勉強", "資格試験"])
    else:
        detail_item = st.sidebar.selectbox("詳細項目", ["生活の知恵", "キャリア設計", "健康管理"])

mode = st.sidebar.radio("対話モード", ["一般会話", "専門家対話", "論文検索・要約", "コーダーモード"])
token_slider = st.sidebar.slider("会話の長さ", 1, 5, 3)
expertise_slider = st.sidebar.slider("専門性", 1, 5, 3)

st.sidebar.progress(st.session_state.token_usage)
st.sidebar.caption(f"残り容量: {st.session_state.token_usage}%")

def call_groq(prompt, system_prompt=""):
    if not GROQ_API_KEY:
        return "コード内の GROQ_API_KEY が設定されていません。"
    url = "https://api.groq.com/openai/v1/chat/completions"
    headers = {"Authorization": f"Bearer {GROQ_API_KEY}", "Content-Type": "application/json"}
    temp = 0.1 + (expertise_slider * 0.15)
    max_tokens = token_slider * 600
    payload = {
        "model": "llama-3.3-70b-versatile",
        "messages": [
            {"role": "system", "content": f"あなたは{APP_NAME}です。日本語で回答してください。専門性レベル: {expertise_slider}/5。 {system_prompt}"},
            {"role": "user", "content": prompt}
        ],
        "temperature": temp,
        "max_tokens": max_tokens
    }
    try:
        resp = requests.post(url, json=payload, headers=headers)
        if resp.status_code != 200:
            return f"Error: {resp.status_code} - {resp.text}"
        return resp.json()['choices'][0]['message']['content']
    except Exception as e:
        return str(e)

def call_gemini(prompt, system_prompt=""):
    if not GEMINI_API_KEY:
        return "コード内の GEMINI_API_KEY が設定されていません。"
    model_name = "gemini-1.5-flash"
    url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
    full_prompt = f"{system_prompt}\\n\\nUser: {prompt}"
    payload = {"contents": [{"parts": [{"text": full_prompt}]}]}
    try:
        resp = requests.post(url, json=payload)
        if resp.status_code != 200:
            error_msg = resp.json().get("error", {}).get("message", str(resp.status_code))
            return f"Error: {error_msg}"
        return resp.json()['candidates'][0]['content']['parts'][0]['text']
    except Exception as e:
        return str(e)

def search_arxiv(query):
    base_url = "http://export.arxiv.org/api/query?"
    params = f"search_query=all:{query}&start=0&max_results=3"
    try:
        resp = requests.get(base_url + params)
        root = ET.fromstring(resp.content)
        results = []
        for entry in root.findall('{http://www.w3.org/2005/Atom}entry'):
            title = entry.find('{http://www.w3.org/2005/Atom}title').text
            summary = entry.find('{http://www.w3.org/2005/Atom}summary').text
            link = entry.find('{http://www.w3.org/2005/Atom}id').text
            results.append(f"Title: {title}\\nSummary: {summary[:200]}...\\nURL: {link}")
        return "\\n\\n".join(results) if results else "Not found"
    except:
        return "API Error"

def call_wolfram(query):
    if not WOLFRAM_APPID:
        return "コード内の WOLFRAM_APPID が設定されていません。"
    url = f"http://api.wolframalpha.com/v1/result?appid={WOLFRAM_APPID}&i={query}"
    try:
        resp = requests.get(url)
        return resp.text if resp.status_code == 200 else "No result"
    except:
        return "API Error"

st.title(APP_NAME)
st.text(f"{category_main} > {category_mid} > {detail_item} | {mode}")

for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

if prompt := st.chat_input("Input message"):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.spinner("Processing"):
        response = ""
        if mode == "コーダーモード":
            response = call_groq(prompt, "Programming expert")
        elif mode == "論文検索・要約":
            if "NCBI" in detail_item or "生命科学" in category_mid:
                response = f"NCBI search results for: {prompt}"
            else:
                response = search_arxiv(prompt)
        elif mode == "専門家対話":
            if "Wolfram" in detail_item or "数学" in category_main:
                wa_res = call_wolfram(prompt)
                if "設定されていません" in wa_res:
                    response = wa_res
                else:
                    response = call_groq(f"Wolfram: {wa_res} Query: {prompt}")
            else:
                response = call_groq(prompt, f"Expert in {detail_item}")
        else:
            sys_msg = "Luke-Bot Assistant"
            response = call_gemini(prompt, sys_msg)
        st.session_state.token_usage = max(0, st.session_state.token_usage - 2)

    with st.chat_message("assistant"):
        st.markdown(response)
    st.session_state.messages.append({"role": "assistant", "content": response})
`
        },
      });
    </script>
  </body>
</html>
